{
  "feature": "Generate SQLAlchemy Models from Schema Documentation",
  "workflow_type": "feature",
  "workflow_rationale": "This is a multi-phase feature adding 63+ SQLAlchemy models organized into domain modules, requiring proper sequencing due to foreign key dependencies between tables",
  "phases": [
    {
      "id": "phase-1-setup",
      "name": "Setup Model Infrastructure",
      "type": "setup",
      "description": "Create the models directory structure and base utilities",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create models directory and __init__.py package file",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/__init__.py"
          ],
          "patterns_from": [
            "app/database/__init__.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models import *; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created app/database/models/__init__.py as an empty package file following the project pattern. Verification passed successfully.",
          "updated_at": "2025-12-21T19:52:29.038382+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Create base.py with shared mixins and utilities (TimestampMixin, UUIDMixin)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/base.py"
          ],
          "patterns_from": [
            "app/database/event.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models.base import TimestampMixin; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Verified complete: base.py exists with UUIDMixin, TimestampMixin, and BaseModelMixin. Python syntax validated. Already committed in f854506.",
          "updated_at": "2025-12-21T19:57:33.773013+00:00"
        }
      ]
    },
    {
      "id": "phase-2-process",
      "name": "Process Management Models",
      "type": "implementation",
      "description": "Create models for process versioning, nodes, edges, prompts, and sections (10 tables)",
      "depends_on": [
        "phase-1-setup"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create process.py with ProcessVersion, ProcessCommitment, ProcessNodeType, ProcessNode, ProcessFlowEdge, ProcessPrompt, PromptPackTemplate, PromptPackPrompt, ProcessSection, SectionPrompt models",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/process.py"
          ],
          "patterns_from": [
            "app/database/event.py",
            "ai_docs/context/source_docs/schema/process_schema.md"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models.process import ProcessVersion, ProcessNode, ProcessSection; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Verified complete: process.py contains all 10 models (ProcessVersion, ProcessCommitment, ProcessNodeType, ProcessNode, ProcessFlowEdge, ProcessPrompt, PromptPackTemplate, PromptPackPrompt, ProcessSection, SectionPrompt). Committed in a170dd4. Syntax validation passed with py_compile.",
          "updated_at": "2025-12-21T20:22:17.109497+00:00"
        }
      ]
    },
    {
      "id": "phase-3-storyteller",
      "name": "Storyteller and Life Event Models",
      "type": "implementation",
      "description": "Create models for storytellers and their life events with flexible child tables (12 tables)",
      "depends_on": [
        "phase-1-setup"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create storyteller.py with Storyteller, StorytellerBoundary, StorytellerPreference, LifeEvent, LifeEventTimespan, LifeEventLocation, LifeEventParticipant, LifeEventDetail, LifeEventTrauma, LifeEventBoundary, LifeEventMedia, LifeEventPreference models",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/storyteller.py"
          ],
          "patterns_from": [
            "app/database/event.py",
            "ai_docs/context/source_docs/schema/storyteller_schema.md"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models.storyteller import Storyteller, LifeEvent, StorytellerBoundary; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created storyteller.py with 12 SQLAlchemy models: Storyteller, StorytellerBoundary, StorytellerPreference, LifeEvent, LifeEventTimespan, LifeEventLocation, LifeEventParticipant, LifeEventDetail, LifeEventTrauma, LifeEventBoundary, LifeEventMedia, LifeEventPreference. All models use UUID primary keys, JSONB/ARRAY columns for flexible data, proper relationships with back_populates, and appropriate indexes. Syntax verified with py_compile.",
          "updated_at": "2025-12-21T20:21:32.917000+00:00"
        }
      ]
    },
    {
      "id": "phase-4-session",
      "name": "Session Models",
      "type": "implementation",
      "description": "Create models for goal-oriented sessions with interactions and artifacts (12 tables)",
      "depends_on": [
        "phase-2-process",
        "phase-3-storyteller"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create session_models.py with StorytellerSession (renamed from Session to avoid conflict with app/database/session.py), SessionScope, SessionProfile, SessionProgress, SessionSectionStatus, SessionSynthesis, SessionArchetype, SessionLifeEvent, SessionInteraction, SessionArtifact, SessionTemplate, SessionNote models",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/session_models.py"
          ],
          "patterns_from": [
            "app/database/event.py",
            "ai_docs/context/source_docs/schema/session_schema.md"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models.session_models import StorytellerSession, SessionInteraction, SessionArtifact; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Verified complete: session_models.py contains all 12 models (StorytellerSession, SessionScope, SessionProfile, SessionProgress, SessionSectionStatus, SessionSynthesis, SessionArchetype, SessionLifeEvent, SessionInteraction, SessionArtifact, SessionTemplate, SessionNote). Already committed in 0533e94. Syntax validated with py_compile.",
          "updated_at": "2025-12-21T20:27:42.783837+00:00"
        }
      ]
    },
    {
      "id": "phase-5-collection",
      "name": "Collection Models",
      "type": "implementation",
      "description": "Create models for organizing life events into thematic collections (7 tables)",
      "depends_on": [
        "phase-3-storyteller"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Create collection.py with Collection, CollectionLifeEvent, CollectionGrouping, CollectionGroupingMember, CollectionRelationship, CollectionTag, CollectionSynthesis models",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/collection.py"
          ],
          "patterns_from": [
            "app/database/event.py",
            "ai_docs/context/source_docs/schema/collection_schema.md"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models.collection import Collection, CollectionLifeEvent, CollectionGrouping; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created collection.py with 7 models: Collection, CollectionLifeEvent, CollectionGrouping, CollectionGroupingMember, CollectionRelationship, CollectionTag, CollectionSynthesis. All models follow established patterns with UUID primary keys, JSONB/ARRAY columns for PostgreSQL, proper relationships with back_populates, and indexes as specified in schema. Syntax verification passed.",
          "updated_at": "2025-12-21T20:32:15.066642+00:00"
        }
      ]
    },
    {
      "id": "phase-6-story",
      "name": "Story/Book Models",
      "type": "implementation",
      "description": "Create models for the book manuscript with chapters, scenes, and characters (11 tables)",
      "depends_on": [
        "phase-3-storyteller",
        "phase-5-collection"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Create story.py with Story, StoryChapter, ChapterSection, StoryCollection, StoryCharacter, CharacterRelationship, CharacterAppearance, StoryTheme, ChapterTheme, StoryScene, StoryDraft models",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/story.py"
          ],
          "patterns_from": [
            "app/database/event.py",
            "ai_docs/context/source_docs/schema/story_schema.md"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models.story import Story, StoryChapter, StoryCharacter, StoryScene; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-7-operations",
      "name": "System Operations Models",
      "type": "implementation",
      "description": "Create models for progress tracking, agents, requirements, and exports (12 tables)",
      "depends_on": [
        "phase-2-process",
        "phase-3-storyteller",
        "phase-4-session",
        "phase-5-collection",
        "phase-6-story"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-7-1",
          "description": "Create operations.py with StorytellerProgress, StorytellerSectionSelection, StorytellerSectionStatus, ScopeType, ArchetypeAnalysis, UserFeedback, Agent, AgentInstance, Requirement, EditRequirement, BookExport, BookExportDelivery models",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/database/models/operations.py"
          ],
          "patterns_from": [
            "app/database/event.py",
            "ai_docs/context/source_docs/schema/system_operations_schema.md"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models.operations import StorytellerProgress, Agent, AgentInstance, Requirement; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-8-integration",
      "name": "Integration and Wiring",
      "type": "integration",
      "description": "Update imports in package files and alembic/env.py, then run migrations",
      "depends_on": [
        "phase-7-operations"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-8-1",
          "description": "Update models/__init__.py to export all models from all modules",
          "service": "main",
          "files_to_modify": [
            "app/database/models/__init__.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "app/database/__init__.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import sys; sys.path.insert(0, 'app'); from database.models import Storyteller, Story, Collection, Agent; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-8-2",
          "description": "Update app/alembic/env.py to import all new model modules for autogenerate support",
          "service": "main",
          "files_to_modify": [
            "app/alembic/env.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "app/alembic/env.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd app && python -c \"from alembic import config; print('Alembic configured')\"",
            "expected": "Alembic configured"
          },
          "status": "pending"
        },
        {
          "id": "subtask-8-3",
          "description": "Generate Alembic migration for all new models",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "app/alembic/versions/*.py"
          ],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "ls app/alembic/versions/*.py 2>/dev/null | wc -l | xargs echo 'Migration files:'",
            "expected": "Migration files: >= 1"
          },
          "status": "pending",
          "notes": "Run: cd app && alembic revision --autogenerate -m 'Add all schema models'"
        },
        {
          "id": "subtask-8-4",
          "description": "Apply migration to local Supabase database",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd app && alembic upgrade head && echo 'Migration applied'",
            "expected": "Migration applied"
          },
          "status": "pending",
          "notes": "Ensure Supabase Docker container is running before applying"
        }
      ]
    },
    {
      "id": "phase-9-verification",
      "name": "Database Verification",
      "type": "integration",
      "description": "Verify all tables and relationships exist in the database",
      "depends_on": [
        "phase-8-integration"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-9-1",
          "description": "Verify all expected tables exist in the database",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd app && python -c \"from database.session import engine; from sqlalchemy import inspect; inspector = inspect(engine); tables = inspector.get_table_names(); print(f'Tables created: {len(tables)}'); assert len(tables) >= 60, f'Expected 60+ tables, got {len(tables)}'\"",
            "expected": "Tables created: >= 60"
          },
          "status": "pending"
        },
        {
          "id": "subtask-9-2",
          "description": "Verify foreign key relationships are properly created",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd app && python -c \"from database.session import engine; from sqlalchemy import inspect; inspector = inspect(engine); fks = sum(len(inspector.get_foreign_keys(t)) for t in inspector.get_table_names()); print(f'Foreign keys: {fks}'); assert fks >= 50, 'Expected 50+ foreign keys'\"",
            "expected": "Foreign keys: >= 50"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 9,
    "total_subtasks": 14,
    "services_involved": [
      "main"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-process",
            "phase-3-storyteller"
          ],
          "reason": "Both depend only on phase-1-setup, different model files"
        },
        {
          "phases": [
            "phase-4-session",
            "phase-5-collection"
          ],
          "reason": "Can run in parallel after their dependencies complete, different model files"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.4x faster than sequential"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 001 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All 63 SQLAlchemy models compile without import errors",
      "Migration generation completes successfully",
      "Migration application creates all tables",
      "All foreign key relationships exist in database",
      "All indexes created as specified in schema docs",
      "No regressions - existing Event table still works"
    ],
    "verification_steps": [
      {
        "name": "Model Import Check",
        "command": "cd app && python -c \"from database.models import *; print('All models imported successfully')\"",
        "expected_outcome": "All models imported successfully",
        "type": "unit",
        "required": true,
        "blocking": true
      },
      {
        "name": "Alembic Migration Generation",
        "command": "cd app && alembic revision --autogenerate -m 'Schema models'",
        "expected_outcome": "Migration file created without errors",
        "type": "integration",
        "required": true,
        "blocking": true
      },
      {
        "name": "Migration Application",
        "command": "cd app && alembic upgrade head",
        "expected_outcome": "Migration applied successfully",
        "type": "integration",
        "required": true,
        "blocking": true
      },
      {
        "name": "Table Count Verification",
        "command": "cd app && python -c \"from database.session import engine; from sqlalchemy import inspect; print(f'Tables: {len(inspect(engine).get_table_names())}')\"",
        "expected_outcome": "Tables: 60+",
        "type": "integration",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Database schema changes require integration tests to verify migrations run successfully and tables are created correctly. No security concerns as this is internal schema generation."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "cd app && python -c \"from database.models import *; print('OK')\""
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "cd app && alembic upgrade head && alembic downgrade -1 && alembic upgrade head"
      ],
      "services_to_test": [
        "main"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": true,
      "checks": [
        "migrations-exist",
        "migrations-applied",
        "schema-valid",
        "foreign-keys-valid",
        "indexes-created"
      ]
    }
  },
  "qa_signoff": null,
  "last_updated": "2025-12-21T20:32:15.066655+00:00"
}