<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Curling Pro - Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #0d1117 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      color: white;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 30px;
    }
    h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 400px;
      margin: 100px auto;
      padding: 30px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .login-form h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    .login-form input {
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 14px;
    }
    .login-form button {
      padding: 14px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .login-form button:hover {
      opacity: 0.9;
    }
    .error {
      color: #ef4444;
      text-align: center;
      font-size: 14px;
    }
    .dashboard {
      display: none;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-card .label {
      color: #94a3b8;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #4ade80;
    }
    .stat-card .sub {
      color: #64748b;
      font-size: 12px;
      margin-top: 4px;
    }
    .section {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h3 {
      margin-bottom: 15px;
      font-size: 16px;
      color: #94a3b8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th {
      color: #64748b;
      font-size: 12px;
      text-transform: uppercase;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }
    .refresh-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #4ade80;
      background: transparent;
      color: #4ade80;
      cursor: pointer;
      font-size: 14px;
    }
    .refresh-btn:hover {
      background: rgba(74, 222, 128, 0.1);
    }
    .date-filter {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 20px;
    }
    .date-filter select, .date-filter input {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 14px;
    }
    .chart-container {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 4px;
      padding: 10px 0;
    }
    .chart-bar {
      flex: 1;
      background: linear-gradient(180deg, #4ade80 0%, #22c55e 100%);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      position: relative;
    }
    .chart-bar:hover {
      opacity: 0.8;
    }
    .chart-bar .tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a2e;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      margin-bottom: 4px;
    }
    .chart-bar:hover .tooltip {
      display: block;
    }
    .logout-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #64748b;
      background: transparent;
      color: #94a3b8;
      cursor: pointer;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Form -->
    <div id="login-section" class="login-form">
      <h2>Admin Dashboard</h2>
      <p style="color: #64748b; text-align: center; font-size: 14px;">Enter your Supabase service role key to access analytics</p>
      <input type="text" id="supabase-url" placeholder="Supabase URL">
      <input type="password" id="service-key" placeholder="Service Role Key">
      <button onclick="login()">Login</button>
      <div id="login-error" class="error"></div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
      <header>
        <h1>Curling Pro Analytics</h1>
        <div style="display: flex; gap: 10px;">
          <button class="refresh-btn" onclick="loadData()">Refresh</button>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </header>

      <!-- Session Stats -->
      <div class="section">
        <h3>Sessions (Today)</h3>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div class="stat-card">
            <div class="label">Today's Sessions</div>
            <div class="value" id="today-sessions">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Avg Duration</div>
            <div class="value" id="avg-duration">-</div>
            <div class="sub">minutes</div>
          </div>
          <div class="stat-card">
            <div class="label">Mobile Users</div>
            <div class="value" id="mobile-pct">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Total All-Time</div>
            <div class="value" id="total-sessions">-</div>
          </div>
        </div>
      </div>

      <!-- Sessions Chart -->
      <div class="section">
        <h3>Sessions - Last 14 Days</h3>
        <div id="sessions-chart" class="chart-container">
          <div class="loading">Loading chart...</div>
        </div>
      </div>

      <!-- Local Games Stats -->
      <div class="section">
        <h3 style="color: #4ade80;">Local Games (Today)</h3>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div class="stat-card">
            <div class="label">Career Started</div>
            <div class="value" id="local-career-started" style="color: #4ade80;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Career Completed</div>
            <div class="value" id="local-career-completed" style="color: #4ade80;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Quick Play Started</div>
            <div class="value" id="local-quickplay-started" style="color: #4ade80;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Quick Play Completed</div>
            <div class="value" id="local-quickplay-completed" style="color: #4ade80;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">2-Player Started</div>
            <div class="value" id="local-2player-started" style="color: #4ade80;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">2-Player Completed</div>
            <div class="value" id="local-2player-completed" style="color: #4ade80;">-</div>
          </div>
        </div>
      </div>

      <!-- Online Games Stats -->
      <div class="section">
        <h3 style="color: #38bdf8;">Online Games (Today)</h3>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div class="stat-card">
            <div class="label">Games Started</div>
            <div class="value" id="online-started" style="color: #38bdf8;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Games Completed</div>
            <div class="value" id="online-completed" style="color: #38bdf8;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Completion Rate</div>
            <div class="value" id="online-completion-rate" style="color: #38bdf8;">-</div>
          </div>
        </div>
      </div>

      <!-- Practice Mode Stats -->
      <div class="section">
        <h3 style="color: #a78bfa;">üéØ Practice Mode (Today)</h3>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div class="stat-card">
            <div class="label">Sessions</div>
            <div class="value" id="practice-sessions" style="color: #a78bfa;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Drills Started</div>
            <div class="value" id="practice-drills" style="color: #a78bfa;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Drills Completed</div>
            <div class="value" id="practice-completed" style="color: #a78bfa;">-</div>
          </div>
        </div>
        <table style="margin-top: 15px;">
          <thead>
            <tr>
              <th>Drill Type</th>
              <th>Attempts</th>
              <th>Successes</th>
              <th>Success Rate</th>
            </tr>
          </thead>
          <tbody id="practice-breakdown">
            <tr><td colspan="4" class="loading">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Learn Mode Stats -->
      <div class="section">
        <h3 style="color: #60a5fa;">üìö Learn Mode (Today)</h3>
        <div class="stats-grid" style="margin-bottom: 0;">
          <div class="stat-card">
            <div class="label">Sessions</div>
            <div class="value" id="learn-sessions" style="color: #60a5fa;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Games Started</div>
            <div class="value" id="learn-games" style="color: #60a5fa;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Games Completed</div>
            <div class="value" id="learn-completed" style="color: #60a5fa;">-</div>
          </div>
          <div class="stat-card">
            <div class="label">Tutorials Shown</div>
            <div class="value" id="learn-tutorials" style="color: #60a5fa;">-</div>
          </div>
        </div>
      </div>

      <!-- Errors -->
      <div class="section">
        <h3 style="color: #ef4444;">Errors (Last 24 Hours)</h3>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Message</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody id="error-log">
            <tr><td colspan="4" class="loading">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Feedback -->
      <div class="section">
        <h3 style="color: #f59e0b;">üì¨ Feedback (Last 30 Days)</h3>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>From</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody id="feedback-log">
            <tr><td colspan="4" class="loading">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Recent Events -->
      <div class="section">
        <h3>Recent Events (Last 50)</h3>
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Type</th>
              <th>Name</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody id="recent-events">
            <tr><td colspan="4" class="loading">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Active Sessions -->
      <div class="section">
        <h3>Active Sessions (Last 30 min)</h3>
        <table>
          <thead>
            <tr>
              <th>Session ID</th>
              <th>Device</th>
              <th>Started</th>
              <th>Last Activity</th>
            </tr>
          </thead>
          <tbody id="active-sessions">
            <tr><td colspan="4" class="loading">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    let supabase = null;

    // Check for saved credentials
    window.onload = function() {
      const savedUrl = localStorage.getItem('admin_supabase_url');
      const savedKey = localStorage.getItem('admin_service_key');
      if (savedUrl && savedKey) {
        document.getElementById('supabase-url').value = savedUrl;
        document.getElementById('service-key').value = savedKey;
        login();
      }
    };

    window.login = async function() {
      const url = document.getElementById('supabase-url').value.trim();
      const key = document.getElementById('service-key').value.trim();
      const errorEl = document.getElementById('login-error');

      if (!url || !key) {
        errorEl.textContent = 'Please enter both URL and key';
        return;
      }

      try {
        supabase = createClient(url, key);

        // Test connection by querying analytics_sessions
        const { data, error } = await supabase
          .from('analytics_sessions')
          .select('id')
          .limit(1);

        if (error) {
          throw new Error(error.message);
        }

        // Save credentials
        localStorage.setItem('admin_supabase_url', url);
        localStorage.setItem('admin_service_key', key);

        // Show dashboard
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';

        // Load data
        loadData();
      } catch (e) {
        errorEl.textContent = 'Login failed: ' + e.message;
      }
    };

    window.logout = function() {
      localStorage.removeItem('admin_supabase_url');
      localStorage.removeItem('admin_service_key');
      location.reload();
    };

    window.loadData = async function() {
      if (!supabase) return;

      try {
        // Get today's date
        const today = new Date().toISOString().split('T')[0];
        const thirtyMinAgo = new Date(Date.now() - 30 * 60 * 1000).toISOString();

        // Fetch all data in parallel
        const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();

        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();

        const [
          todaySessions,
          todayEvents,
          allSessions,
          recentEvents,
          activeSessions,
          last14Days,
          recentErrors,
          recentFeedback
        ] = await Promise.all([
          // Today's sessions
          supabase
            .from('analytics_sessions')
            .select('*')
            .gte('started_at', today),

          // Today's events
          supabase
            .from('analytics_events')
            .select('*')
            .gte('created_at', today),

          // Total sessions
          supabase
            .from('analytics_sessions')
            .select('id', { count: 'exact', head: true }),

          // Recent events
          supabase
            .from('analytics_events')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(50),

          // Active sessions
          supabase
            .from('analytics_sessions')
            .select('*')
            .gte('last_activity', thirtyMinAgo)
            .is('ended_at', null),

          // Last 14 days for chart
          supabase
            .from('analytics_sessions')
            .select('started_at')
            .gte('started_at', new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString()),

          // Errors (last 24 hours)
          supabase
            .from('analytics_events')
            .select('*')
            .eq('event_type', 'error')
            .gte('created_at', twentyFourHoursAgo)
            .order('created_at', { ascending: false })
            .limit(50),

          // Feedback (last 30 days)
          supabase
            .from('feedback')
            .select('*')
            .gte('created_at', thirtyDaysAgo)
            .order('created_at', { ascending: false })
            .limit(50)
        ]);

        // Update stats
        const todaySessionCount = todaySessions.data?.length || 0;
        document.getElementById('today-sessions').textContent = todaySessionCount;
        document.getElementById('total-sessions').textContent = allSessions.count || 0;

        // Calculate average duration
        const sessionsWithDuration = todaySessions.data?.filter(s => s.duration_seconds) || [];
        const avgDuration = sessionsWithDuration.length > 0
          ? Math.round(sessionsWithDuration.reduce((sum, s) => sum + s.duration_seconds, 0) / sessionsWithDuration.length / 60)
          : 0;
        document.getElementById('avg-duration').textContent = avgDuration;

        // Mobile percentage
        const mobileCount = todaySessions.data?.filter(s => s.device_type === 'mobile').length || 0;
        const mobilePct = todaySessionCount > 0 ? Math.round(mobileCount / todaySessionCount * 100) : 0;
        document.getElementById('mobile-pct').textContent = mobilePct + '%';

        // Game counts from events - separate local vs online
        const gameStarts = todayEvents.data?.filter(e => e.event_type === 'game_start') || [];
        const gameCompletes = todayEvents.data?.filter(e => e.event_type === 'game_complete') || [];

        // Local games by mode
        const careerStarts = gameStarts.filter(e => e.event_name === 'career').length;
        const careerCompletes = gameCompletes.filter(e => e.event_name === 'career').length;
        const quickplayStarts = gameStarts.filter(e => e.event_name === 'quickplay').length;
        const quickplayCompletes = gameCompletes.filter(e => e.event_name === 'quickplay').length;
        const twoPlayerStarts = gameStarts.filter(e => e.event_name === '2player').length;
        const twoPlayerCompletes = gameCompletes.filter(e => e.event_name === '2player').length;

        document.getElementById('local-career-started').textContent = careerStarts;
        document.getElementById('local-career-completed').textContent = careerCompletes;
        document.getElementById('local-quickplay-started').textContent = quickplayStarts;
        document.getElementById('local-quickplay-completed').textContent = quickplayCompletes;
        document.getElementById('local-2player-started').textContent = twoPlayerStarts;
        document.getElementById('local-2player-completed').textContent = twoPlayerCompletes;

        // Online games
        const onlineStarts = gameStarts.filter(e => e.event_name === 'online').length;
        const onlineCompletes = gameCompletes.filter(e => e.event_name === 'online').length;
        const onlineRate = onlineStarts > 0 ? Math.round(onlineCompletes / onlineStarts * 100) : 0;

        document.getElementById('online-started').textContent = onlineStarts;
        document.getElementById('online-completed').textContent = onlineCompletes;
        document.getElementById('online-completion-rate').textContent = onlineRate + '%';

        // Practice Mode Stats
        const practicePageViews = todayEvents.data?.filter(e =>
          e.event_type === 'page_view' && e.event_name === 'practice_mode'
        ) || [];
        const practiceDrillStarts = todayEvents.data?.filter(e =>
          e.event_type === 'practice_start' ||
          (e.event_type === 'page_view' && e.event_name?.includes('practice_drill'))
        ) || [];
        const practiceDrillCompletes = todayEvents.data?.filter(e =>
          e.event_type === 'practice_complete'
        ) || [];
        const practiceAttempts = todayEvents.data?.filter(e =>
          e.event_type === 'practice_attempt'
        ) || [];
        const practiceSuccesses = todayEvents.data?.filter(e =>
          e.event_type === 'practice_success'
        ) || [];

        document.getElementById('practice-sessions').textContent = practicePageViews.length;
        document.getElementById('practice-drills').textContent = practiceDrillStarts.length || practiceAttempts.length;
        document.getElementById('practice-completed').textContent = practiceDrillCompletes.length || practiceSuccesses.length;

        // Practice drill breakdown
        const drillBreakdown = {};
        practiceAttempts.forEach(e => {
          const drill = e.event_name || e.event_data?.drill || 'unknown';
          if (!drillBreakdown[drill]) drillBreakdown[drill] = { attempts: 0, successes: 0 };
          drillBreakdown[drill].attempts++;
        });
        practiceSuccesses.forEach(e => {
          const drill = e.event_name || e.event_data?.drill || 'unknown';
          if (!drillBreakdown[drill]) drillBreakdown[drill] = { attempts: 0, successes: 0 };
          drillBreakdown[drill].successes++;
        });

        const drillRows = Object.entries(drillBreakdown).map(([drill, data]) => {
          const rate = data.attempts > 0 ? Math.round(data.successes / data.attempts * 100) : 0;
          return `<tr>
            <td style="text-transform: capitalize;">${drill}</td>
            <td>${data.attempts}</td>
            <td>${data.successes}</td>
            <td>${rate}%</td>
          </tr>`;
        }).join('') || '<tr><td colspan="4" style="color: #64748b;">No practice data yet</td></tr>';
        document.getElementById('practice-breakdown').innerHTML = drillRows;

        // Learn Mode Stats
        const learnPageViews = todayEvents.data?.filter(e =>
          e.event_type === 'page_view' && e.event_name === 'learn_mode'
        ) || [];
        const learnGameStarts = todayEvents.data?.filter(e =>
          e.event_type === 'game_start' && e.event_data?.learnMode === true
        ) || [];
        const learnGameCompletes = todayEvents.data?.filter(e =>
          e.event_type === 'game_complete' && e.event_data?.learnMode === true
        ) || [];
        const tutorialEvents = todayEvents.data?.filter(e =>
          e.event_type === 'tutorial' || e.event_name?.includes('tutorial')
        ) || [];

        document.getElementById('learn-sessions').textContent = learnPageViews.length;
        document.getElementById('learn-games').textContent = learnGameStarts.length;
        document.getElementById('learn-completed').textContent = learnGameCompletes.length;
        document.getElementById('learn-tutorials').textContent = tutorialEvents.length;

        // Errors table
        const errorRows = recentErrors.data?.map(e => {
          const time = new Date(e.created_at).toLocaleString();
          const data = e.event_data || {};
          const location = data.source ? `${data.source}:${data.line || '?'}` : '-';
          const message = (data.message || e.event_name || 'Unknown error').slice(0, 100);
          return `<tr style="color: #fca5a5;">
            <td style="font-size: 12px;">${time}</td>
            <td>${e.event_name}</td>
            <td style="font-size: 12px;">${message}</td>
            <td style="font-size: 12px;">${location}</td>
          </tr>`;
        }).join('') || '<tr><td colspan="4" style="color: #4ade80;">No errors - all good!</td></tr>';
        document.getElementById('error-log').innerHTML = errorRows;

        // Feedback table
        console.log('Feedback query result:', recentFeedback);
        let feedbackRows;
        if (recentFeedback.error) {
          console.error('Feedback error:', recentFeedback.error);
          feedbackRows = `<tr><td colspan="4" style="color: #ef4444;">Error: ${recentFeedback.error.message}</td></tr>`;
        } else {
          feedbackRows = recentFeedback.data?.map(f => {
            const time = new Date(f.created_at).toLocaleString();
            const typeColor = f.type === 'bug' ? '#ef4444' : '#3b82f6';
            const typeLabel = f.type === 'bug' ? 'üêõ Bug' : '‚ú® Feature';
            const from = f.name || f.email || 'Anonymous';
            const message = (f.message || '').slice(0, 150);
            return `<tr>
              <td style="font-size: 12px;">${time}</td>
              <td style="color: ${typeColor};">${typeLabel}</td>
              <td style="font-size: 12px;">${from}${f.email ? '<br><span style="color:#64748b;">' + f.email + '</span>' : ''}</td>
              <td style="font-size: 12px; max-width: 300px; word-wrap: break-word;">${message}</td>
            </tr>`;
          }).join('') || '<tr><td colspan="4" style="color: #64748b;">No feedback yet</td></tr>';
        }
        document.getElementById('feedback-log').innerHTML = feedbackRows;

        // Recent events table
        const eventRows = recentEvents.data?.map(e => {
          const time = new Date(e.created_at).toLocaleTimeString();
          const dataStr = e.event_data ? JSON.stringify(e.event_data).slice(0, 50) : '-';
          return `<tr>
            <td>${time}</td>
            <td>${e.event_type}</td>
            <td>${e.event_name}</td>
            <td style="font-size: 12px; color: #64748b;">${dataStr}</td>
          </tr>`;
        }).join('') || '<tr><td colspan="4">No events</td></tr>';
        document.getElementById('recent-events').innerHTML = eventRows;

        // Active sessions table
        const activeRows = activeSessions.data?.map(s => {
          const started = new Date(s.started_at).toLocaleTimeString();
          const lastActive = new Date(s.last_activity).toLocaleTimeString();
          return `<tr>
            <td style="font-size: 12px;">${s.session_id.slice(0, 20)}...</td>
            <td>${s.device_type || 'unknown'}</td>
            <td>${started}</td>
            <td>${lastActive}</td>
          </tr>`;
        }).join('') || '<tr><td colspan="4">No active sessions</td></tr>';
        document.getElementById('active-sessions').innerHTML = activeRows;

        // Sessions chart (last 14 days)
        const chartData = {};
        for (let i = 13; i >= 0; i--) {
          const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
          const key = date.toISOString().split('T')[0];
          chartData[key] = 0;
        }

        last14Days.data?.forEach(s => {
          const date = s.started_at.split('T')[0];
          if (chartData[date] !== undefined) {
            chartData[date]++;
          }
        });

        const maxCount = Math.max(...Object.values(chartData), 1);
        const chartHtml = Object.entries(chartData).map(([date, count]) => {
          const height = Math.max((count / maxCount) * 180, 4);
          const day = new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          return `<div class="chart-bar" style="height: ${height}px;">
            <div class="tooltip">${day}: ${count} sessions</div>
          </div>`;
        }).join('');
        document.getElementById('sessions-chart').innerHTML = chartHtml;

      } catch (e) {
        console.error('Error loading data:', e);
      }
    };
  </script>
</body>
</html>
